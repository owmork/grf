<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assessing heterogeneity with RATE • grf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Assessing heterogeneity with RATE">
<meta property="og:description" content="grf">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/grf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rate.html">Assessing heterogeneity with RATE</a>
    </li>
    <li>
      <a href="../articles/categorical_inputs.html">Categorical inputs</a>
    </li>
    <li>
      <a href="../articles/survival.html">Causal forest with time-to-event data</a>
    </li>
    <li>
      <a href="../articles/muhats.html">Estimating conditional means</a>
    </li>
    <li>
      <a href="../articles/diagnostics.html">Evaluating a causal forest fit</a>
    </li>
    <li>
      <a href="../articles/llf.html">Local linear forests</a>
    </li>
    <li>
      <a href="../articles/policy_learning.html">Policy learning</a>
    </li>
    <li>
      <a href="../articles/visualize_tree.html">Visualize trees</a>
    </li>
  </ul>
</li>
<li>
  <a href="../REFERENCE.html">Algorithm reference</a>
</li>
<li>
  <a href="../DEVELOPING.html">Developing</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/grf-labs/grf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Assessing heterogeneity with RATE</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/grf-labs/grf/blob/master/vignettes/rate.Rmd"><code>vignettes/rate.Rmd</code></a></small>
      <div class="hidden name"><code>rate.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">grf</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)</pre></body></html></div>
<p>This vignette gives a brief introduction to how the <em>Rank-Weighted Average Treatment Effect</em> (<em>RATE</em>) available in the function <a href="https://grf-labs.github.io/grf/reference/rank_average_treatment_effect.html">rank_average_treatment_effect</a> can be used to evaluate how good treatment <em>prioritization rules</em> (such as conditional average treatment effect estimates) are at distinguishing subpopulations with different treatment effects, or whether there is any notable heterogeneity present. The second part of the vignette gives a worked example from a medical setting using (synthetic) data from the SPRINT and ACCORD hypertension drug trials. For complete details we refer to the <a href="https://arxiv.org/abs/2111.07966">RATE paper</a>.</p>
<div id="treatment-prioritization-rules" class="section level2">
<h2 class="hasAnchor">
<a href="#treatment-prioritization-rules" class="anchor"></a>Treatment prioritization rules</h2>
<p>We are in the familiar experimental setting (or unconfounded observational study) and are interested in the problem of determining which individuals to assign a binary treatment <span class="math inline">\(W=\{0, 1\}\)</span> and the associated value of this treatment allocation strategy. Given some subject characteristics <span class="math inline">\(X_i\)</span> we have access to a subject-specific treatment <em>prioritization rule</em> <span class="math inline">\(S(X_i)\)</span> which assigns scores to subjects. This prioritization rule should give a high score to units which we believe to have a large benefit of treatment and a low score to units with a low benefit of treatment. By benefit of treatment, we mean the difference in outcomes <span class="math inline">\(Y\)</span> from receiving the treatment given some subject characteristics <span class="math inline">\(X_i\)</span>, as given by the conditional average treatment effect (CATE)</p>
<p><span class="math display">\[\tau(X_i) = E[Y_i(1) - Y_i(0) \,|\, X_i = x],\]</span> where <span class="math inline">\(Y(1)\)</span> and <span class="math inline">\(Y(0)\)</span> are potential outcomes corresponding to the two treatment states.</p>
<p>You might ask: why the general focus on an arbitrary rule <span class="math inline">\(S(X_i)\)</span> when you define benefit as measured by <span class="math inline">\(\tau(X_i)\)</span>? Isn’t it obvious that the estimated CATEs would serve the best purpose for treatment targeting? The answer is that this general problem formulation is quite convenient, as in some settings we may lack sufficient data to power an accurate CATE estimator and have to rely on other approaches to target treatment. Examples of other approaches are heuristics derived by domain experts or simpler models predicting risk scores (where risk is defined as <span class="math inline">\(P[Y = 1 | X_i = x]\)</span> and <span class="math inline">\(Y \in \{0, 1\}\)</span> with <span class="math inline">\(Y=1\)</span> being an adverse outcome), which is quite common in clinical applications. Consequently, in finite samples we may sometimes do better by relying on simpler rules which are correlated with the CATEs, than on noisy and complicated CATE estimates (remember: CATE estimation is a hard statistical task, and by focusing on a general rule we may circumvent some of the problems of obtaining accurate non-parametric point estimates by instead asking for estimates that <em>rank</em> units according to treatment benefit). Also, even if you have an accurate CATE estimator, there may be many to choose from (neural nets/random forests/various metalearners/etc). The question is: given a set of treatment prioritization rules <span class="math inline">\(S(X_i)\)</span>, which one (if any) should we use?</p>
<p>The tool we propose to employ in this situation is a RATE metric. It takes as input a prioritization rule <span class="math inline">\(S(X_i)\)</span> which may be based on estimated CATEs, risk scores, etc, and outputs a scalar metric that can be used to assess how well it targets treatment (it measures the <em>value</em> of a prioritization rule while being agnostic to exactly how it was derived). A RATE metric has two components: the “TOC” and the area under the TOC, which we explain in the following section.</p>
</div>
<div id="quantifying-treatment-benefit-the-targeting-operator-characteristic" class="section level2">
<h2 class="hasAnchor">
<a href="#quantifying-treatment-benefit-the-targeting-operator-characteristic" class="anchor"></a>Quantifying treatment benefit: the Targeting Operator Characteristic</h2>
<p>As outlined in the previous section, we are interested in the presence of heterogeneity and how much benefit there is to prioritizing treatment based on this heterogeneity using a targeting rule <span class="math inline">\(S(X_i)\)</span>. By “benefit” we mean the expected increase in outcomes from giving treatment to a fraction of the population with the largest scores <span class="math inline">\(S(X_i)\)</span> as opposed to giving treatment to a randomly selected fraction of the same size.</p>
<p>As a first step towards a suitable metric that helps us asses this, some visual aid would be nice. One reasonable thing to do would be to chop the population up into groups defined by <span class="math inline">\(S(X_i)\)</span>, then compare the ATE in these groups to the overall ATE from treating everyone, then plot this over all groups. This is what the <em>Targeting Operator Characteristic</em> (TOC) does, where each group is the top q-th fraction of individuals with the largest prioritization score <span class="math inline">\(S(X_i)\)</span>.</p>
<p>Let <span class="math inline">\(F\)</span> be the distribution function of <span class="math inline">\(S(X_i)\)</span> and <span class="math inline">\(q \in (0, 1]\)</span> the fraction of samples treated, the TOC at <span class="math inline">\(q\)</span> is then defined by</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
&amp;\textrm{TOC}(q) = E[Y_i(1) - Y_i(0) \,|\, S(X_i) \geq F^{-1}_{S(X_i)}(1 - q)]\\
&amp; \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  - E[Y_i(1) - Y_i(0)],
\end{split}
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(F_{S(X_i)}\)</span> is the distribution function of <span class="math inline">\(S(X_i)\)</span>. The TOC curve is motivated by the <em>Receiver Operating Characteristic</em> (ROC), a widely used metric for assessing the performance of a classification rule.</p>
<p>As a toy example, suppose we let <span class="math inline">\(\tau(X_i) = X_1\)</span> where <span class="math inline">\(X_1 \sim N(0, 1)\)</span>. Then the TOC curve when prioritizing using <span class="math inline">\(S(X_i) = \tau(X_i)\)</span> looks like:</p>
<p><img src="rate_files/figure-html/toc-plot-1.png" width="700"></p>
<p>Note how high the TOC is for the first few units treated. This is intuitive since our toy CATEs are normally distributed with mean zero; if we identify and treat only the top 5% of units with treatment effects greater than <span class="math inline">\(z_{0.95}\)</span>, the benefit over treating everyone (0) is large. As we move further along, mixing in more people with lower treatment effect, we get closer to the ATE, until at <span class="math inline">\(q=1\)</span> we equal it.</p>
</div>
<div id="rate-the-area-under-the-toc" class="section level2">
<h2 class="hasAnchor">
<a href="#rate-the-area-under-the-toc" class="anchor"></a>RATE: The area under the TOC</h2>
<p>This picture suggests a quite natural way to summarize the TOC curve in terms of the ability of <span class="math inline">\(S(X_i)\)</span> to rank individuals by treatment benefit: sum up the area under the curve. This is exactly how the <strong>RATE</strong> is defined, it is the <em>A</em>rea <em>U</em>nder the <em>TOC</em> (“AUTOC”)</p>
<p><span class="math display">\[\textrm{RATE} = \int_0^1 \textrm{TOC}(q) dq .\]</span> If there is barely any heterogeneity in <span class="math inline">\(\tau(X_i)\)</span> this area will be vanishingly small and in the special case where <span class="math inline">\(\tau(X_i)\)</span> is constant, it’s zero. Thinking one step ahead, if our <em>estimated</em> rule <span class="math inline">\(S(X_i)\)</span> does well in identifying the individuals with very different benefits of treatment, we would expect this metric to be <em>positive</em>. Conversely, if it does badly, or there are barely any benefits to stratifying treatment, we would expect it to be <em>negative</em> or close to <em>zero</em>, respectively.</p>
<p><img src="rate_files/figure-html/toc-plot-autoc-1.png" width="700"></p>
<p>There are different ways this area can be summed up, which gives rise to different RATE metrics. We refer to the integral above as the “AUTOC”. This places more weight on areas under the curve where the expected treatment benefit is largest. When non-zero treatment effects are concentrated among a small subset of the population this weighting is powerful for testing against a sharp null (AUTOC = 0).</p>
<p>Another way to sum this area would be to weight each point on the curve by <span class="math inline">\(q\)</span>: <span class="math inline">\(\int_0^1 q \textrm{TOC}(q) dq\)</span>. We refer to this metric as the “QINI” (Radcliffe, 2007). This weighting implies placing as much weight on units with low treatment effects as on units with high treatment effects. When non-zero treatment effects are more diffuse across the entire population, this weighting tends to give greater power when testing against a null effect.</p>
<p>Another thing to note is that the “high-vs-low” out-of-bag CATE quantile construction used in Athey and Wager (2019) can also be seen as a kind of RATE, where in place of Qini’s identity weighting it would have point mass at q = a given quantile.</p>
</div>
<div id="estimating-the-rate" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-the-rate" class="anchor"></a>Estimating the RATE</h2>
<p>The overview in the previous section gave a stylized introduction where we imagined we knew <span class="math inline">\(\tau(X_i)\)</span>. In practice these have to be estimated and the appropriate <em>feasible definition</em> (using <span class="math inline">\(S(X_i) = \hat \tau(X_i)\)</span> as an example) is: the TOC curve ranks all observations on a test set <span class="math inline">\(X^{test}\)</span> according to a CATE function <span class="math inline">\(\hat \tau^{train}(\cdot)\)</span> estimated on a training set, and compares the ATE for the top q-th fraction of units prioritized by <span class="math inline">\(\hat \tau^{train}(X^{test})\)</span> to the overall ATE:</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
&amp;\textrm{TOC}(q) = E[Y^{test}_i(1) - Y^{test}_i(0) \,|\, \hat \tau^{train}(X^{test}_i) \geq \hat F^{-1}(1 - q)]\\
&amp; \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  - E[Y^{test}_i(1) - Y^{test}_i(0)],
\end{split}
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(\hat F\)</span> is the empirical distribution function of <span class="math inline">\(\hat \tau^{train}(X^{test})\)</span>. The <code>rank_average_treatment_effect</code> function delivers a AIPW-style<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> doubly robust estimator of the TOC and RATE using a forest trained on a separate evaluation set. For details on the derivation of the doubly robust estimator and the associated central limit theorem, see Yadlowsky et al. (2021).</p>
</div>
<div id="an-application-to-sprint-and-accord" class="section level2">
<h2 class="hasAnchor">
<a href="#an-application-to-sprint-and-accord" class="anchor"></a>An application to SPRINT and ACCORD</h2>
<p>To illustrate RATE we consider an example application from a medical setting. Two large randomized trials <em>ACCORD</em> (ACCORD Study Group, 2010) and <em>SPRINT</em> (SPRINT Research Group, 2015) conducted on similar populations and designed to measure the effectiveness of a hypertension treatment reach different conclusions. SPRINT found the treatment was effective, ACCORD found that the treatment was not effective. Various explanations for this finding have been proposed, we’ll focus on one in particular here: the hypothesis that the difference is due to <em>heterogeneity in treatment effects</em> (see Yadlowsky et al., 2021 for references).</p>
<p>This hypothesis has a testable implication implied by the previous section: if there is significant heterogeneity present and we are able to effectively estimate these with a powerful CATE estimator, then an estimated RATE on ACCORD and SPRINT should be positive and significant. In particular, our setup implies the following recipe:</p>
<ol style="list-style-type: decimal">
<li><p>Estimate CATE functions <span class="math inline">\(\hat \tau^{ACCORD}(\cdot)\)</span> and <span class="math inline">\(\hat \tau^{SPRINT}(\cdot)\)</span> on ACCORD and SPRINT data.</p></li>
<li><p>Use <span class="math inline">\(\hat \tau^{ACCORD}(X^{SPRINT})\)</span> to evaluate RATE on SPRINT, and vice versa: use <span class="math inline">\(\hat \tau^{SPRINT}(X^{ACCORD})\)</span> to evaluate RATE on ACCORD.</p></li>
<li><p>If both populations exhibit similar HTEs, then a powerful CATE estimator should yield a positive and significant RATE estimate.</p></li>
</ol>
<p>For the purpose of this vignette example we’ll not analyse the original SPRINT/ACCORD data, but rather a <em>smaller simulated</em> example, stored in the <a href="https://github.com/grf-labs/grf/blob/master/r-package/grf/vignettes/synthetic_SPRINT_ACCORD.RData">GRF repository</a>. For details on the simulator see the <a href="https://github.com/som-shahlab/RATE-experiments/blob/main/experiments/section_5_SPRINT_and_ACCORD/simulators/simulators_description.pdf">RATE repository</a>.</p>
<p>The outcome data in this trial is <em>right-censored</em>, so we cannot use any ordinary “out-of-the-box” CATE estimator to estimate treatment effects, rather, we need one that takes censoring into account. For this reason we use GRF’s <code>causal_survival_forest</code> (and refer to the <a href="https://grf-labs.github.io/grf/reference/causal_survival_forest.html">documentation</a> for details). Below is an illustration of the simulated trial data.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># Read in dummy data from https://github.com/grf-labs/grf/tree/master/r-package/grf/vignettes</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">"synthetic_SPRINT_ACCORD.RData"</span>)
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">Y.sprint</span>, <span class="no">Y.accord</span>),
                 <span class="kw">D</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">D.sprint</span>, <span class="no">D.accord</span>),
                 <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"synthetic-SPRINT"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">Y.sprint</span>)),
                          <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"synthetic-ACCORD"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">Y.accord</span>))))
<span class="no">df</span>$<span class="no">Censored</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">df</span>$<span class="no">D</span>, <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">Y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Censored</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="no">data</span> ~ <span class="no">.</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">30</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Time until primary outcome (days)"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Frequency"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span>()</pre></body></html></div>
<p><img src="rate_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>The SPRINT trial was halted early due to a low number of events occurring and thus have a very high censoring rate. The target estimand we consider in this example is the difference in restricted mean survival time (RMST) conditional on covariates:</p>
<p><span class="math display">\[\tau(x) = E[T(1) \land h - T(0) \land h \, | X = x],\]</span> where <span class="math inline">\(T\)</span> is the (censored) survival time and we set <span class="math inline">\(h\)</span> (<code>horizon</code> in the GRF package) to ~ 3 years, after which the SPRINT trial data nearly stops exhibiting events. Since the treatment was randomized we set the propensity scores <code>W.hat</code><span class="math inline">\(=E[W_i \, | X_i = x]\)</span> to the mean number of treated units.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">horizon</span> <span class="kw">&lt;-</span> <span class="fl">3</span> * <span class="fl">365</span>
<span class="no">csf.sprint</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_survival_forest.html">causal_survival_forest</a></span>(<span class="no">X.sprint</span>, <span class="no">Y.sprint</span>, <span class="no">W.sprint</span>, <span class="no">D.sprint</span>,
                                     <span class="kw">W.hat</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">W.sprint</span>), <span class="kw">target</span> <span class="kw">=</span> <span class="st">"RMST"</span>, <span class="kw">horizon</span> <span class="kw">=</span> <span class="no">horizon</span>)

<span class="no">csf.accord</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_survival_forest.html">causal_survival_forest</a></span>(<span class="no">X.accord</span>, <span class="no">Y.accord</span>, <span class="no">W.accord</span>, <span class="no">D.accord</span>,
                                     <span class="kw">W.hat</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">W.accord</span>), <span class="kw">target</span> <span class="kw">=</span> <span class="st">"RMST"</span>, <span class="kw">horizon</span> <span class="kw">=</span> <span class="no">horizon</span>)

<span class="no">tau.hat.sprint</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">csf.accord</span>, <span class="no">X.sprint</span>)$<span class="no">predictions</span>
<span class="no">tau.hat.accord</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">csf.sprint</span>, <span class="no">X.accord</span>)$<span class="no">predictions</span></pre></body></html></div>
<p>Evaluating RATE on SPRINT and ACCORD, using estimated CATE functions from ACCORD and SPRINT then gives</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">rate.sprint</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/rank_average_treatment_effect.html">rank_average_treatment_effect</a></span>(<span class="no">csf.sprint</span>, <span class="no">tau.hat.sprint</span>, <span class="kw">target</span> <span class="kw">=</span> <span class="st">"AUTOC"</span>)
<span class="no">rate.accord</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/rank_average_treatment_effect.html">rank_average_treatment_effect</a></span>(<span class="no">csf.accord</span>, <span class="no">tau.hat.accord</span>, <span class="kw">target</span> <span class="kw">=</span> <span class="st">"AUTOC"</span>)

<span class="no">rate.sprint</span>
<span class="co">#&gt;   estimate  std.err             target</span>
<span class="co">#&gt;  -10.88788 6.904641 priorities | AUTOC</span>
<span class="no">rate.accord</span>
<span class="co">#&gt;   estimate  std.err             target</span>
<span class="co">#&gt;  -18.66819 11.67814 priorities | AUTOC</span></pre></body></html></div>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">rate.sprint</span>, <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"Treated fraction"</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="st">"TOC evaluated on SPRINT\n tau(X) estimated from ACCORD"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">rate.accord</span>, <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"Treated fraction"</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="st">"TOC evaluated on ACCORD\n tau(X) estimated from SPRINT"</span>)</pre></body></html></div>
<p><img src="rate_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>In this semi-synthetic example both AUTOCs are insignificant at conventional levels, suggesting there is no evidence of significant HTEs in the two trials. Note: this can also be attributed to a) low power, as perhaps the sample size is not large enough to detect HTEs, b) that the HTE estimator does not detect them, or c) the heterogeneity in the treatment effects along observable predictor variables are negligible. For a broader analysis comparing different prioritization strategies on the SPRINT and ACCORD datasets, see Yadlowsky et al. (2021).</p>
</div>
<div id="funding" class="section level2">
<h2 class="hasAnchor">
<a href="#funding" class="anchor"></a>Funding</h2>
<p>Development of the RATE functionality in GRF was supported in part by the award 5R01HL144555 from the National Institutes of Health.</p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>ACCORD Study Group. Effects of Intensive Blood-Pressure Control in Type 2 Diabetes Mellitus. <em>New England Journal of Medicine</em>, 362(17):1575–1585, 2010.</p>
<p>Susan Athey and Stefan Wager. Estimating Treatment Effects with Causal Forests: An Application. <em>Observational Studies</em>, 5, 2019.</p>
<p>Radcliffe, Nicholas. Using control groups to target on predicted lift: Building and assessing uplift model. <em>Direct Marketing Analytics Journal</em> (14-21), 2007.</p>
<p>SPRINT Research Group. A Randomized Trial of Intensive Versus Standard Blood-Pressure Control. <em>New England Journal of Medicine</em>, 373(22):2103–2116, 2015.</p>
<p>Yadlowsky, Steve, Scott Fleming, Nigam Shah, Emma Brunskill, and Stefan Wager. Evaluating Treatment Prioritization Rules via Rank-Weighted Average Treatment Effects. <em>arXiv preprint arXiv:2111.07966</em> (<a href="https://arxiv.org/abs/2111.07966">arxiv</a>)</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>AIPW = Augmented Inverse-Propensity Weighting (Robins, Rotnitzky, and Zhao, 1994)<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Julie Tibshirani, Susan Athey, Erik Sverdrup, Stefan Wager.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
