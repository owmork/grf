<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Causal forest with time-to-event data • grf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Causal forest with time-to-event data">
<meta property="og:description" content="grf">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/grf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rate.html">Assessing heterogeneity with RATE</a>
    </li>
    <li>
      <a href="../articles/categorical_inputs.html">Categorical inputs</a>
    </li>
    <li>
      <a href="../articles/survival.html">Causal forest with time-to-event data</a>
    </li>
    <li>
      <a href="../articles/muhats.html">Estimating conditional means</a>
    </li>
    <li>
      <a href="../articles/diagnostics.html">Evaluating a causal forest fit</a>
    </li>
    <li>
      <a href="../articles/llf.html">Local linear forests</a>
    </li>
    <li>
      <a href="../articles/policy_learning.html">Policy learning</a>
    </li>
    <li>
      <a href="../articles/visualize_tree.html">Visualize trees</a>
    </li>
  </ul>
</li>
<li>
  <a href="../REFERENCE.html">Algorithm reference</a>
</li>
<li>
  <a href="../DEVELOPING.html">Developing</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/grf-labs/grf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Causal forest with time-to-event data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/grf-labs/grf/blob/master/vignettes/survival.Rmd"><code>vignettes/survival.Rmd</code></a></small>
      <div class="hidden name"><code>survival.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">grf</span>)</pre></body></html></div>
<p>This vignette gives a brief beginner-friendly overview of how non-parametric estimators like GRF can be used to flexibly estimate treatment effects in a survival setting where we want to remain agnostic on assumptions for the censoring and survival process. The first part of this vignette gives a basic intro to right-censored data and issues with estimating an average survival time. The second part shows how GRF can use <code>sample.weights</code> to construct an IPCW-based <a href="https://grf-labs.github.io/grf/reference/causal_forest.html">causal_forest</a>, and explains the more powerful estimation approach available in the function <a href="https://grf-labs.github.io/grf/reference/causal_survival_forest.html">causal_survival_forest</a>.</p>
<div id="right-censored-data" class="section level2">
<h2 class="hasAnchor">
<a href="#right-censored-data" class="anchor"></a>Right-censored data</h2>
<p><img src="California_Sea_Otter.jpg" align="right" height="120" alt="California sea otter, photo credit Michael Baird"> Imagine we are interested in estimating <span class="math inline">\(E[T]\)</span>: how long on average it takes before a sea otter pup catches its first prey. We drive down to Moss Landing approximately one hour away from Stanford campus and equip a handful of same-age pups with a device which tells us if it catches a sea urchin, scallop, crab, etc. Due to limited funds and time constraints our study ends after 10 days. During these 10 days our measurement device may also fail randomly (batteries may stop working - they run out completely after 12 days, it malfunctions, etc.). This means that for some of our subjects instead of observing the time they catch a prey we observe when the device stops working, i.e. the time at which they get censored: <span class="math inline">\(C\)</span>. The following graph illustrates what this data may look like, the black bar denotes the study end.</p>
<div class="figure">
<img src="survival_files/figure-html/unnamed-chunk-2-1.png" alt="Right-censored data" width="700"><p class="caption">
Right-censored data
</p>
</div>
<p>Subject two and three: their measurement device malfunctions and they drop out of the study, all we know is they had not caught anything at the last measurement time. Subjects one, four, and five catch their first prey during the first 10 days.</p>
<p>This setup describes a typical data collection process in time-to-event studies called <em>right-censoring</em>. Instead of observing a subject’s event time <span class="math inline">\(T_i\)</span> we observe <span class="math inline">\(Y_i\)</span> defined as</p>
<p><span class="math display">\[\begin{equation}
  Y_i =
    \begin{cases}
      T_i &amp; \text{if} \, T_i \leq C_i \\
      C_i &amp; \text{otherwise}
    \end{cases}       
\end{equation}\]</span></p>
<p>along with an event indicator <span class="math inline">\(D_i\)</span></p>
<p><span class="math display">\[\begin{equation}
D_i =
    \begin{cases}
      1 &amp; \text{if} \, T_i \leq C_i \\
      0 &amp; \text{otherwise.}
    \end{cases}
\end{equation}\]</span></p>
<p>In our example subject one, four and five all experienced the event (<span class="math inline">\(D=1\)</span>) while two and three did not (<span class="math inline">\(C=0\)</span>). Since in survival settings the event taking place is often a death, the event times <span class="math inline">\(T\)</span> are often referred to as <em>failure times</em>.</p>
<p>We’ll proceed by making matters concrete with a simulated toy example. Let the time until a pup gets its first catch follow an exponential distribution with rate <span class="math inline">\(0.1\)</span> i.e. <span class="math inline">\(T \sim \textrm{Exp}(0.1)\)</span>. Let the measurement device be equally likely to malfunction any time during the lifespan of the device, i.e the censoring probability is uniformly distributed with <span class="math inline">\(C \sim U(0, 12)\)</span>. If we plot the distribution of observed events <span class="math inline">\(D\cdot T\)</span> as well as the distribution of <span class="math inline">\(T\)</span> they would look like:</p>
<div class="figure">
<img src="survival_files/figure-html/density-1.png" alt="Densities" width="700"><p class="caption">
Densities
</p>
</div>
<p>One immediate thing to note from this plot is that we have to revise our target estimand: it is actually not possible to estimate the mean of <span class="math inline">\(T\)</span> as its density has support all the way up to 60+ days, and our study ends at 10 days. What we can estimate is a truncated mean, which we call the <em>restricted mean survival time</em> (RMST) defined as</p>
<p><span class="math display">\[E[\min(T, h)] = E[T \land h],\]</span> where <span class="math inline">\(h\)</span> is a truncation parameter (called <code>horizon</code> in the GRF package). If we set <span class="math inline">\(h=10\)</span> we can see from the plot that <span class="math inline">\(E[T \land h]\)</span> is defined since we observe events (blue graph) all up until <span class="math inline">\(t=10\)</span> days. Let’s denote our new truncated survival time by <span class="math inline">\(\hat T = T \land h\)</span>. This truncation also implies an updated event indicator: all samples still tracked at time <span class="math inline">\(h\)</span> are considered as having an observed event at time <span class="math inline">\(h\)</span> regardless whether they are censored or not because we know they must not have experienced the event at time <span class="math inline">\(h\)</span>. Denote this by <span class="math inline">\(\hat D = \max(D, \, 1\{T\geq h\})\)</span>. This looks like:</p>
<div class="figure">
<img src="survival_files/figure-html/trunc-density-1.png" alt="Truncated densities" width="700"><p class="caption">
Truncated densities
</p>
</div>
<p>From this plot it is evident that we can’t estimate <span class="math inline">\(E[\hat T]\)</span> using only the observed events, we need to take censoring into account, otterwise we’ll get biased estimates. As seen from the plots, the two densities overlap, with significant mass in all regions up to <span class="math inline">\(h\)</span>, which means that if we know the censoring probabilities, we can use inverse probability weighting to upweight the observed events and recover an unbiased estimate of <span class="math inline">\(E[\hat T]\)</span>. Define the censoring probabilities <span class="math inline">\(P[C &gt; \hat T \,|\, \hat T] = E[\hat D \,|\, \hat T]\)</span>. If we upweight the observed events by <span class="math inline">\(1 / E[\hat D \,|\, \hat T]\)</span> we get (using the law of iterated expectations):</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
&amp; E\left[\frac{\hat D \hat T}{E[\hat D \,|\, \hat T]}\right]  \\
&amp;= E\left[ E\left[\frac{\hat D \hat T}{E[\hat D \,|\, \hat T]} \,\big|\, \hat T \right]\right]  \\
&amp;= E\left[\frac{\hat T}{E[\hat D \,|\, \hat T]} E[\hat D \,|\, \hat T]\right] \\
&amp;= E[\hat T].
\end{split}
\end{equation*}\]</span></p>
<p>The following code snippet illustrates with a toy example:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">100000</span>
<span class="no">event.time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span>(<span class="no">n</span>, <span class="kw">rate</span> <span class="kw">=</span> <span class="fl">0.1</span>)
<span class="no">censor.time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="no">n</span>, <span class="fl">0</span>, <span class="fl">12</span>)
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="no">event.time</span>, <span class="no">censor.time</span>)
<span class="no">D</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">event.time</span> <span class="kw">&lt;=</span> <span class="no">censor.time</span>)

<span class="co"># Define the new truncated Y and updated event indicator</span>
<span class="no">horizon</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
<span class="no">Dh</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">D</span>, <span class="no">Y</span> <span class="kw">&gt;=</span> <span class="no">horizon</span>)
<span class="no">Yh</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="no">Y</span>, <span class="no">horizon</span>)

<span class="no">observed.events</span> <span class="kw">&lt;-</span> (<span class="no">Dh</span> <span class="kw">==</span> <span class="fl">1</span>)
<span class="no">censoring.prob</span> <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">punif</a></span>(<span class="no">Yh</span>[<span class="no">observed.events</span>], <span class="fl">0</span>, <span class="fl">12</span>) <span class="co"># P(C &gt; T)</span>
<span class="no">sample.weights</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / <span class="no">censoring.prob</span>

<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="no">event.time</span>, <span class="no">horizon</span>)) <span class="co"># True unobserved truncated mean</span>
<span class="co">#&gt; [1] 6.33776</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">Yh</span>[<span class="no">observed.events</span>]) <span class="co"># Biased</span>
<span class="co">#&gt; [1] 4.076917</span>
<span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="no">Yh</span>[<span class="no">observed.events</span>], <span class="no">sample.weights</span>) <span class="co"># IPC weighted</span>
<span class="co">#&gt; [1] 6.367093</span></pre></body></html></div>
<p>This section suggests one way to adopt a <code>causal_forest</code> for right-censored data would be <em>inverse probability of censoring weighting</em> (IPCW) and an important purely mechanical observation can be made before the subsequent CATE estimation paragraph: to get stable estimates we would like for <span class="math inline">\(P[C_i &gt; T_i]\)</span> to not get too low as that implies explosive sample weights. Intuitively from the density plot, we want to set a threshold that has “considerable” probability of still observing events, if the tail is very thin our estimation task is harder.</p>
</div>
<div id="cate-estimation-and-right-censored-data" class="section level2">
<h2 class="hasAnchor">
<a href="#cate-estimation-and-right-censored-data" class="anchor"></a>CATE estimation and right-censored data</h2>
<p>Continuing with the fictional experimental setup described in the beginning, imagine instead we randomly split the otter pups into two groups: treated (<span class="math inline">\(W=1\)</span>) and control (<span class="math inline">\(W=0\)</span>). The treated group is given hunting lessons that we think helps them catch prey more effectively. The control group is given nothing. We also gather some subject specific covariates <span class="math inline">\(X\)</span> like <span class="math inline">\(X_1\)</span>=otter size, etc. We are interested in measuring the expected difference in outcomes (RMST) conditional on covariates, defined as:</p>
<p><span class="math display">\[\tau(x) = E[T(1) \land h - T(0) \land h \, | X = x],\]</span> where <span class="math inline">\(T(1)\)</span> and <span class="math inline">\(T(0)\)</span> are potential outcomes corresponding to the two treatment states. In order to estimate this we require something beyond the standard identifying assumptions for CATE estimation with observational data (<em>unconfoundedness/ignorability</em> and <em>overlap</em>).</p>
<p>As the example in the previous section made clear, the censoring mechanism was completely random (failing batteries and measuring devices). This is a crucial assumption, and we require:</p>
<ol style="list-style-type: decimal">
<li>
<em>Ignorable censoring</em>: censoring is independent of survival time conditionally on treatment and covariates, <span class="math inline">\(T_i \perp C_i \mid X_i, \, W_i\)</span>.</li>
</ol>
<p>We can get a sense of what the second identifying assumption is by looking at the density plots from the previous section. We saw that for the restricted mean to be identified, we needed there to be some chance of observing an event during our study period, captured by the <code>horizon</code> parameter <span class="math inline">\(h\)</span>. This second assumption make that requirement:</p>
<ol start="2" style="list-style-type: decimal">
<li>
<em>Positivity</em>: each subject has some probability of having an event observed, <span class="math inline">\(P[C_i \leq h \, | X_i, \, W_i] \leq 1 - \eta_C\)</span> for some <span class="math inline">\(\eta_C &gt; 0\)</span>.</li>
</ol>
<p>Continuing with the simple stylized example from the first section, we simulate the following setup, where we stop collecting samples after t=10 days, with random treatment assignment and where <span class="math inline">\(\tau(X)\)</span> depends on the first covariate <span class="math inline">\(X_1\)</span>.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">500</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"size"</span>, <span class="st">"fur.density"</span>, <span class="st">"x3"</span>, <span class="st">"x4"</span>, <span class="st">"x5"</span>)
<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span>)
<span class="no">horizon</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
<span class="no">event.time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span>(<span class="no">n</span>, <span class="kw">rate</span> <span class="kw">=</span> <span class="fl">0.1</span> + <span class="no">W</span> * <span class="no">X</span>[, <span class="fl">1</span>]), <span class="no">horizon</span>)
<span class="no">censor.time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="no">n</span>, <span class="fl">0</span>, <span class="fl">12</span>)
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="no">event.time</span>, <span class="no">censor.time</span>), <span class="fl">2</span>)
<span class="no">D</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">event.time</span> <span class="kw">&lt;=</span> <span class="no">censor.time</span>)</pre></body></html></div>
</div>
<div id="causal-forest-with-sample-weights" class="section level2">
<h2 class="hasAnchor">
<a href="#causal-forest-with-sample-weights" class="anchor"></a>Causal forest with sample weights</h2>
<p>This section shows how we can use estimated sample weights to adopt <code>causal_forest</code> for IPCW estimation. Most GRF estimators have an optional <code>sample.weights</code> argument which is taken into account during all steps of the GRF algorithm (relabeling/splitting/prediction). We start by using a <a href="https://grf-labs.github.io/grf/reference/survival_forest.html">survival_forest</a> to estimate the censoring process <span class="math inline">\(P[C_i &gt; t \, | X_i = x]\)</span>, then pick out the appropriate censoring probabilities <span class="math inline">\(P[C_i &gt; \hat T_i \, | X_i = x]\)</span>. In our example the censoring probabilities are “easy” to estimate: they are all uniform. However, many applications involve more complex censoring patterns, it would not be unreasonable to expect that the size of the otter pup mattered for the censoring probabilities, as a larger pup might allow the measurement device to be strapped on more securely and thus less likely to break than on a smaller pup. Estimating <span class="math inline">\(P[C_i &gt; t \, | X_i = x]\)</span> non-parametrically with GRF’s <code>survival_forest</code> allows us to be agnostic to this.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">sf.censor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/survival_forest.html">survival_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="fl">1</span> - <span class="no">D</span>)
<span class="no">sf.pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">sf.censor</span>)

<span class="no">censoring.prob</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="no">n</span>)
<span class="no">Y.index</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/findInterval.html">findInterval</a></span>(<span class="no">Y</span>, <span class="no">sf.pred</span>$<span class="no">failure.times</span>)
<span class="no">censoring.prob</span>[<span class="no">Y.index</span> <span class="kw">&gt;</span> <span class="fl">0</span>] <span class="kw">&lt;-</span> <span class="no">sf.pred</span>$<span class="no">predictions</span>[<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fl">1</span>:<span class="no">n</span>, <span class="no">Y.index</span>)]
<span class="no">observed.events</span> <span class="kw">&lt;-</span> (<span class="no">D</span> <span class="kw">==</span> <span class="fl">1</span>)
<span class="no">sample.weights</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / <span class="no">censoring.prob</span>[<span class="no">observed.events</span>]</pre></body></html></div>
<p>Note: when doing inverse weighting it is usually a good idea to plot the histogram of the weights to get a sense of stability behavior. If you look at the simulated data, we also discretize the event values by rounding (<code><a href="https://rdrr.io/r/base/Round.html">round(Y, 2)</a></code>): this is done because training a survival forest involves estimating a survival curve on a grid consisting of all unique event times, and having this grid unreasonably dense brings little benefits w.r.t statistical accuracy over the extra computational cost (the optional <code>failure.times</code> argument embeds this functionality).</p>
<p>Putting everything together we train a causal forest on all observed events, and pass in the appropriate sample weights. Since we know our study is randomized with equal treatment assignment we also supply the know propensity score <code>W.hat</code> <span class="math inline">\(=E[W_i \, | X_i = x] = 0.5\)</span>:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">cf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_forest.html">causal_forest</a></span>(<span class="no">X</span>[<span class="no">observed.events</span>, ], <span class="no">Y</span>[<span class="no">observed.events</span>], <span class="no">W</span>[<span class="no">observed.events</span>],
                    <span class="kw">W.hat</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">sample.weights</span> <span class="kw">=</span> <span class="no">sample.weights</span>)

<span class="fu"><a href="../reference/average_treatment_effect.html">average_treatment_effect</a></span>(<span class="no">cf</span>)
<span class="co">#&gt;   estimate    std.err </span>
<span class="co">#&gt; -3.7757990  0.5685382</span></pre></body></html></div>
<p>The ATE is negative, which suggests that hunting lessons make the otter pup catch their first prey in fewer days than those in the control group. That is, the treatment has a positive estimated impact.</p>
</div>
<div id="causal-survival-forest-csf" class="section level2">
<h2 class="hasAnchor">
<a href="#causal-survival-forest-csf" class="anchor"></a>Causal survival forest (CSF)</h2>
<p>Two drawbacks with the previous approach are:</p>
<ol style="list-style-type: lower-alpha">
<li>It relies on estimated censoring probabilities, and IPCW type estimators are typically not robust to estimation errors in these.</li>
<li>It only considers observations with observed events. If many subjects are censored this suggests an efficiency loss.</li>
</ol>
<p>The method implemented in the function <code>causal_survival_forest</code> alleviates these drawbacks by leveraging insights from the survival literature on censoring robust estimating equations (Robins et al., 1994, Tsiatis, 2007). It does so by taking the (complete-data) causal forest estimating equation <span class="math inline">\(\psi^{(c)}_{\tau(x)}(T, W, ...)\)</span> (the “R-learner”) and turn it into a censoring robust estimating equation <span class="math inline">\(\psi_{\tau(x)}(Y, W, ...)\)</span> by using estimates of the survival and censoring processes <span class="math inline">\(P[C_i &gt; t \, | X_i = X], \, P[T_i &gt; t \, | X_i = X]\)</span> (“<span class="math inline">\(...\)</span>” refers to additional nuisance parameters). The upshot of this “orthogonal” estimating equation is that it will be consistent if either the survival or censoring process is correctly specified, which is very beneficial when we want to estimate these by modern ML tools, such as random survival forests. For more details see the causal survival forest <a href="https://arxiv.org/abs/2001.09887">paper</a>.</p>
<p>We estimate this by specifying <code>target = "RMST"</code> and supplying the given <code>horizon</code> of t=10 days:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">csf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_survival_forest.html">causal_survival_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="no">W</span>, <span class="no">D</span>, <span class="kw">W.hat</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">target</span> <span class="kw">=</span> <span class="st">"RMST"</span>, <span class="kw">horizon</span> <span class="kw">=</span> <span class="fl">10</span>)

<span class="fu"><a href="../reference/average_treatment_effect.html">average_treatment_effect</a></span>(<span class="no">csf</span>)
<span class="co">#&gt;   estimate    std.err </span>
<span class="co">#&gt; -3.7169607  0.3031702</span></pre></body></html></div>
<p>The associated standard errors are smaller than in the previous section since unlike causal forest, CSF does not only use observations with observed events. (Note: when running the command you may see a warning that some estimated censoring probabilities are less than 0.2, this is fine for this application, CSF is just being conservative since as noted previously our estimation approach involves division by these).</p>
<p>We can use <code>best_linear_projection</code> to estimate a linear effect modification measure, and can see that an otter’s size has significant impact, hunting lessons have a greater effect for bigger otter pups:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="../reference/best_linear_projection.html">best_linear_projection</a></span>(<span class="no">csf</span>, <span class="no">X</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Best linear projection of the conditional average treatment effect.</span>
<span class="co">#&gt; Confidence intervals are cluster- and heteroskedasticity-robust (HC3):</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)   </span>
<span class="co">#&gt; (Intercept) -2.46873    1.15783 -2.1322 0.033483 * </span>
<span class="co">#&gt; size        -3.00485    1.10683 -2.7148 0.006863 **</span>
<span class="co">#&gt; fur.density  0.44416    1.08347  0.4099 0.682028   </span>
<span class="co">#&gt; x3           0.41529    0.99106  0.4190 0.675375   </span>
<span class="co">#&gt; x4           0.32168    1.07651  0.2988 0.765207   </span>
<span class="co">#&gt; x5          -0.82328    1.01928 -0.8077 0.419645   </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></pre></body></html></div>
</div>
<div id="other-estimation-targets-survival-probabilities" class="section level2">
<h2 class="hasAnchor">
<a href="#other-estimation-targets-survival-probabilities" class="anchor"></a>Other estimation targets: survival probabilities</h2>
<p>CSF can also be used to estimate the difference in survival probabilities. This option is available through the argument <code>target = "survival.probability"</code> and estimates for a given <code>horizon</code> <span class="math inline">\(h\)</span>:</p>
<p><span class="math display">\[\tau(x) = P[T(1) \geq h \, | X = x] - P[T(0) \geq h \, | X = x].\]</span></p>
<p>This extension can be made naturally using the estimation framework described in the previous section. The rest of this vignette contains details on the general setup. Let <span class="math inline">\(y(\cdot)\)</span> be a deterministic function that satisfies the following:</p>
<ol start="4" style="list-style-type: decimal">
<li>
<em>Finite horizon</em>: The outcome transformation <span class="math inline">\(y(\cdot)\)</span> admits a maximal horizon <span class="math inline">\(0 &lt; h &lt; \infty\)</span>, such that <span class="math inline">\(y(t) = y(h)\)</span> for all <span class="math inline">\(t \geq h\)</span>.</li>
</ol>
<p>The CATE can then be defined as <span class="math inline">\(\tau(x) = E[y(T(1)) - y(T(0)) \, | X = x]\)</span>. The restricted mean survival time is given by the outcome transformation <span class="math inline">\(y(T) = T \land h\)</span>, and the survival function is given by the outcome transformation <span class="math inline">\(y(T) = 1\{T \geq h\}\)</span>. As noted earlier this setup implies we only need to take into account events occurring up until time <span class="math inline">\(h\)</span>. This means that any samples censored past <span class="math inline">\(h\)</span> can be treated as observed at <span class="math inline">\(h\)</span> since if we know they were “alive” in the future, they must have been alive at <span class="math inline">\(h\)</span>. This leads to the new “effective” event indicator:</p>
<ol start="5" style="list-style-type: decimal">
<li>
<em>Effective event indicator</em>: <span class="math inline">\(D^h_i = D_i \lor 1\{Y_i \geq h\}\)</span>.</li>
</ol>
<p>This general setup can also give us some intuition for when we can expect the estimation approach in CSF to give us an efficiency benefit over IPCW: namely when the data has many samples censored before <span class="math inline">\(h\)</span>. The IPCW approach would discard these, but CSF uses them for efficient estimation. Empirically, CSF also does well in settings with complex censoring processes, where the double robustness property comes in handy. For more details on the benefits of different non-parametric estimation techniques across many different survival settings, see Xu et al., (2022).</p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Cui, Yifan, Michael R. Kosorok, Erik Sverdrup, Stefan Wager, and Ruoqing Zhu. Estimating Heterogeneous Treatment Effects with Right-Censored Data via Causal Survival Forests. <em>arXiv preprint arXiv:2001.09887</em> (<a href="https://arxiv.org/abs/2001.09887">arxiv</a>)</p>
<p>Robins, James M., Andrea Rotnitzky, and Lue Ping Zhao. Estimation of Regression Coefficients When Some Regressors are not Always Observed. <em>Journal of the American Statistical Association</em> 89(427), 1994.</p>
<p>Tsiatis, Anastasios A. Semiparametric Theory and Missing Data. <em>Springer Series in Statistics. Springer New York</em>, 2007.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Julie Tibshirani, Susan Athey, Erik Sverdrup, Stefan Wager.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
